{% comment %}
  Product Template Section
{% endcomment %}

<section class="product-template py-20" data-section-id="{{ section.id }}" style="padding-top: 140px;">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
      
      {% comment %} Product Images {% endcomment %}
      <div class="product-images">
        <div class="main-image mb-4">
          {% if product.featured_image %}
            <img 
              src="{{ product.featured_image | img_url: 'large' }}" 
              alt="{{ product.featured_image.alt | default: product.title }}"
              class="w-full h-auto rounded-lg"
              id="product-featured-image"
            >
          {% else %}
            <div class="w-full h-96 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
              <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
          {% endif %}
        </div>
        
        {% if product.images.size > 1 %}
          <div class="thumbnails grid grid-cols-4 gap-4">
            {% for image in product.images limit: 4 %}
              <button 
                type="button"
                class="thumbnail border-2 border-transparent hover:border-red-500 rounded overflow-hidden transition-colors"
                data-image-src="{{ image | img_url: 'large' }}"
              >
                <img 
                  src="{{ image | img_url: 'small' }}" 
                  alt="{{ image.alt | default: product.title }}"
                  class="w-full h-auto"
                >
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {% comment %} Product Info {% endcomment %}
      <div class="product-info">
        <h1 class="text-2xl mb-4">{{ product.title }}</h1>
        
        <div class="product-price mb-6">
          <span class="text-2xl">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="text-lg text-gray-500 line-through ml-2">{{ product.compare_at_price | money }}</span>
          {% endif %}
        </div>

        {% if product.description != blank %}
          <div class="product-description text-gray-600 dark:text-gray-400 mb-8">
            {{ product.description }}
          </div>
        {% endif %}

        {% form 'product', product %}
          {% comment %} Variant Selector {% endcomment %}
          {% unless product.has_only_default_variant %}
            <div class="product-variants mb-6">
              {% for option in product.options_with_values %}
                <div class="variant-option mb-4">
                  <label class="block mb-2">{{ option.name }}</label>
                  <div class="flex flex-wrap gap-2">
                    {% for value in option.values %}
                      <input 
                        type="radio" 
                        id="{{ section.id }}-{{ option.name }}-{{ value | handle }}" 
                        name="options[{{ option.name }}]" 
                        value="{{ value }}"
                        class="hidden variant-input"
                        {% if option.selected_value == value %}checked{% endif %}
                      >
                      <label 
                        for="{{ section.id }}-{{ option.name }}-{{ value | handle }}"
                        class="variant-label border-2 border-gray-300 dark:border-gray-700 px-4 py-2 rounded cursor-pointer hover:border-red-500 transition-colors"
                      >
                        {{ value }}
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endunless %}

          {% comment %} Quantity {% endcomment %}
          <div class="quantity-selector mb-6">
            <label class="block mb-2">Cantidad</label>
            <input 
              type="number" 
              name="quantity" 
              value="1" 
              min="1"
              class="w-20 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 bg-white dark:bg-gray-800"
            >
          </div>

          {% comment %} Add to Cart {% endcomment %}
          <button 
            type="submit" 
            name="add"
            class="add-to-cart-btn w-full bg-red-500 text-white py-4 rounded-lg hover:bg-red-600 transition-all hover:shadow-lg mb-4 flex items-center justify-center gap-2"
            {% unless product.available %}disabled{% endunless %}
            data-product-id="{{ product.id }}"
          >
            <span class="btn-text">
              {% if product.available %}
                Agregar al carrito
              {% else %}
                Agotado
              {% endif %}
            </span>
            <svg class="btn-icon hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
          
          <div class="success-message hidden bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 px-4 py-3 rounded-lg mb-4" role="alert">
            <p class="text-sm">✓ Producto agregado al carrito</p>
          </div>
          
          <div class="error-message hidden bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 px-4 py-3 rounded-lg mb-4" role="alert">
            <p class="text-sm">✗ Error al agregar el producto</p>
          </div>
        {% endform %}

        {% comment %} Product Meta {% endcomment %}
        {% if product.vendor or product.type %}
          <div class="product-meta text-sm text-gray-600 dark:text-gray-400 space-y-2">
            {% if product.vendor %}
              <div><strong>Marca:</strong> {{ product.vendor }}</div>
            {% endif %}
            {% if product.type %}
              <div><strong>Tipo:</strong> {{ product.type }}</div>
            {% endif %}
          </div>
        {% endif %}
      </div>

    </div>

  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Thumbnail click handler
    const thumbnails = document.querySelectorAll('[data-image-src]');
    const featuredImage = document.getElementById('product-featured-image');
    
    thumbnails.forEach(function(thumbnail) {
      thumbnail.addEventListener('click', function() {
        const newSrc = this.dataset.imageSrc;
        if (featuredImage && newSrc) {
          featuredImage.src = newSrc;
        }
        
        // Update active state
        thumbnails.forEach(t => t.classList.remove('border-red-500'));
        this.classList.add('border-red-500');
      });
    });

    // Variant selector styling
    const variantInputs = document.querySelectorAll('.variant-input');
    variantInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        const label = document.querySelector(`label[for="${this.id}"]`);
        document.querySelectorAll('.variant-label').forEach(l => {
          l.classList.remove('border-red-500', 'bg-red-500', 'text-white');
          l.classList.add('border-gray-300', 'dark:border-gray-700');
        });
        label.classList.remove('border-gray-300', 'dark:border-gray-700');
        label.classList.add('border-red-500', 'bg-red-500', 'text-white');
      });
    });

    // Add to cart AJAX
    const productForm = document.querySelector('form[action*="/cart/add"]');
    if (productForm) {
      productForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const addButton = this.querySelector('.add-to-cart-btn');
        const btnText = addButton.querySelector('.btn-text');
        const btnIcon = addButton.querySelector('.btn-icon');
        const successMsg = this.querySelector('.success-message');
        const errorMsg = this.querySelector('.error-message');
        
        // Show loading state
        addButton.disabled = true;
        btnText.classList.add('hidden');
        btnIcon.classList.remove('hidden');
        successMsg.classList.add('hidden');
        errorMsg.classList.add('hidden');
        
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // Success
          btnText.classList.remove('hidden');
          btnIcon.classList.add('hidden');
          addButton.disabled = false;
          successMsg.classList.remove('hidden');
          
          // Update cart count
          fetch('/cart.js')
            .then(r => r.json())
            .then(cart => {
              const cartCount = document.querySelector('[data-cart-count]');
              if (cartCount) {
                cartCount.textContent = cart.item_count;
              }
            });
          
          // Hide success message after 3 seconds
          setTimeout(function() {
            successMsg.classList.add('hidden');
          }, 3000);
        })
        .catch(error => {
          // Error
          btnText.classList.remove('hidden');
          btnIcon.classList.add('hidden');
          addButton.disabled = false;
          errorMsg.classList.remove('hidden');
          
          setTimeout(function() {
            errorMsg.classList.add('hidden');
          }, 3000);
        });
      });
    }
  });
</script>

{% schema %}
{
  "name": "Product Template",
  "tag": "section",
  "class": "product-section"
}
{% endschema %}
